/*! mobile-upload  v1.0.2
* author:tianxiangbing email:
* demo:http://www.lovewebgames.com/jsmodule/p_upload.html 
* git:  2015-06-17 */
!function(a,b){"function"==typeof define&&define.amd?define(["$"],b):"object"==typeof exports?module.exports=b():a.Mobile_upload=b(window.Zepto||window.jQuery||$)}(this,function(a){function b(){window.uploadCount=window.uploadCount||0,window.uploadCount++;var a=Math.random().toString().replace(".","");this.id="upload_"+a+window.uploadCount.toString(),this.fileInput=null}return a.fn.Mobile_upload=function(c){var d=[];return a(this).each(function(){var e=new b,f=a.extend({target:a(this)},c);e.init(f),d.push(e)}),d},b.prototype={init:function(b){this.settings=a.extend({},this.settings,b),this.target=this.settings.target,this.createFile(),this.name=this.settings.name||"files",this.bindEvent(),this.bindFileChange()},touch:function(b,c){function d(a){return c.call(this,a)}var e;a(b).on("click",d),a(b).on("touchmove",function(){e=!0}).on("touchend",function(a){if(a.preventDefault(),!e){var b=c.call(this,a,"touch");b||(a.preventDefault(),a.stopPropagation())}e=!1})},createFile:function(){var b=this;b.fileInput&&b.fileInput.remove(),b.fileInput=a('<input type="file" style="position:absolute;top:0;left:0;width:1px;height:1px;opacity:0;"  accept="image/*" id="'+b.id+'"/>'),a(b.target).after(b.fileInput),this.settings.multiple&&this.fileInput.attr("multiple","multiple"),this.bindFileChange()},bindEvent:function(){var b=this;this.touch(a(this.target),function(){return a(this).parent().siblings().size()>=b.settings.max?b.settings.maxCallback&&b.settings.maxCallback(this):a(b.fileInput).trigger("click"),!1}),b.bindFileEvent()},bindFileEvent:function(){a(this.fileInput).click(function(a){a.stopPropagation()})},bindFileChange:function(){var b=this;a(b.fileInput).off("change"),a(b.fileInput).on("change",function(c){var d=/^image\//i,e=c.target.files;if(b.settings.iframe){var f="up_"+Math.random().toString().replace(".","");b.postFrame(this,c,f)&&b.settings.startUpload&&b.settings.startUpload(b.fileInput,b.target,f)}else if(e)for(var g=e.length-1;g>=0;g--){var h=e[g];!function(c){var e=("key_"+Math.random().toString().replace(".",""),Math.random().toString().replace(".","")),f="up_"+e;if(d.test(c.type)){if(a("#"+b.id).parent().siblings().size()+1>=b.settings.max&&b.settings.maxCallback&&b.settings.maxCallback(a("#"+b.id)),window.FileReader){var g=new FileReader;b.settings.startUpload&&b.settings.startUpload(b.fileInput,b.target,f),g.onload=function(){if(b.createFile(),b.bindFileEvent(),b.settings.imageReady&&b.settings.imageReady(b.fileInput,b.target,this.result,f),b.settings.ajax){var d={};d[b.settings.ajax.name||"file"]=this.result,a.ajax({type:"post",url:b.settings.ajax.url,data:d,dataType:"json",success:function(){b.settings.callback&&b.settings.callback(this.result,c,b.name,b.target,f)},complete:function(){b.settings.endUpload&&b.settings.endUpload(b.fileInput,b.target,f)}}),this.result=null,g.onload=null,g=null}else b.settings.callback&&b.settings.callback(this.result,c,b.name,b.target,f)},g.readAsDataURL(c)}}else alert("不是图片文件")}(h)}})}},b});